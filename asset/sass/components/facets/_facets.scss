@use "../../abstracts/abstracts" as *;

// =============================================================================
// FACETED BROWSE - Modern Filter Sidebar & Results Table
// =============================================================================

.faceted-browse-page,
.block-facetedBrowsePreview {

    // -------------------------------------------------------------------------
    // Layout Container
    // -------------------------------------------------------------------------
    #container {
        flex-wrap: wrap;

        @media (min-width: $xl) {
            flex-wrap: nowrap;
            gap: var(--space-12);
        }
    }

    // -------------------------------------------------------------------------
    // Sidebar
    // -------------------------------------------------------------------------
    #section-sidebar {
        width: 100%;
        overflow: hidden;

        @media (min-width: $xl) {
            border-inline-end: 1px solid var(--border);
            padding-inline-end: var(--space-6);
            width: 25%;
            z-index: auto !important;
            overflow: visible;
        }

        // Mobile fullscreen filter modal
        &.open {
            z-index: var(--z-modal) !important;
            position: fixed !important;
            inset: 0 !important;
            width: 100% !important;
            height: 100vh !important;
            height: 100dvh !important;
            background: var(--bg-surface) !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: var(--space-4) !important;

            @media (min-width: $xl) {
                position: static !important;
                height: auto !important;
                padding: 0 !important;
                padding-inline-end: var(--space-6) !important;
                overflow: visible !important;
            }
        }

        &-modal-toggle {
            margin-block-end: var(--space-6);
        }

        // Reset default field/fieldset styles in sidebar
        .field,
        fieldset {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            margin-block-end: 0;
        }

        button.close-button {
            background-color: var(--primary);
        }
    }

    // Prevent body scroll when filter sidebar is open on mobile
    &.sidebar-open {
        overflow: hidden;

        @media (min-width: $xl) {
            overflow: visible;
        }
    }

    // -------------------------------------------------------------------------
    // Facets Container
    // -------------------------------------------------------------------------
    #facets {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        margin-block-end: var(--space-4);
        overflow: hidden;

        @media (min-width: $xl) {
            height: auto;
            margin-block-end: 0;
            overflow: initial;
        }

        &.show-all {
            height: auto;
            overflow: initial;
        }
    }

    #show-more-facets {
        margin-block-start: var(--space-3);

        @media (min-width: $xl) {
            display: none;
        }
    }

    // -------------------------------------------------------------------------
    // Category & Facet Containers (Accordion-style groups)
    // -------------------------------------------------------------------------
    .categories-container,
    .facets-container {
        border: none;
        padding: 0;
        margin: 0;
    }

    .category,
    .facet {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        margin-block-end: var(--space-3);
        overflow: hidden;
        transition:
            border-color var(--transition-fast),
            box-shadow var(--transition-fast);

        &:hover {
            border-color: color-mix(in srgb, var(--primary) var(--accent-mix-subtle), var(--border));
        }

        &:last-child {
            margin-block-end: 0;
        }

        // Full-text search input styling
        &[data-facet-type="full_text"],
        &:has(.full-text) {
            padding-block-end: var(--space-3);

            input.full-text,
            input[type="text"]:not([type="hidden"]) {
                display: block;
                width: calc(100% - var(--space-8));
                margin: var(--space-3) var(--space-4);
                margin-block-end: 0;
                padding: var(--space-3);
                background: var(--bg-surface);
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                font-family: inherit;
                font-size: var(--text-sm);
                color: var(--text-primary);
                transition:
                    border-color var(--transition-fast),
                    box-shadow var(--transition-fast);

                &:focus {
                    outline: none;
                    border-color: var(--primary);
                    box-shadow: 0 0 0 3px var(--focus-ring);
                }

                &::placeholder {
                    color: var(--muted);
                }
            }
        }

        // Ensure select dropdowns have proper spacing within facet container
        >select,
        select.value {
            margin: var(--space-3) var(--space-4);
            width: calc(100% - var(--space-8)) !important;
            margin-block-end: 0;
        }

        // Add padding at bottom when facet contains a select
        &:has(select) {
            padding-block-end: var(--space-3);
        }
    }

    // -------------------------------------------------------------------------
    // Legends (Facet group headings)
    // -------------------------------------------------------------------------
    .categories-container legend,
    .facets-container legend {
        display: flex;
        align-items: center;
        width: 100%;
        padding: var(--space-4) var(--space-5);
        margin: 0;
        background: linear-gradient(
            180deg,
            color-mix(in srgb, var(--primary) 5%, var(--surface)) 0%,
            var(--surface) 100%
        );
        border-block-end: 1px solid color-mix(in srgb, var(--primary) var(--accent-mix-subtle), var(--border));
        color: color-mix(in srgb, var(--primary) var(--accent-mix-medium), var(--text-heading));
        font-family: $font__headings;
        font-weight: 600;
        font-size: var(--text-sm);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        line-height: 1.4;
    }

    .categories-container legend {
        font-size: var(--text-base);
        text-transform: none;
    }

    // -------------------------------------------------------------------------
    // Select List (Options within each facet)
    // -------------------------------------------------------------------------
    .select-list {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin: 0 !important;
        padding: var(--space-2);
        width: 100%;
        list-style: none;

        &-item {
            margin: 0;
            padding: 0;
            max-width: 100%;
            overflow: hidden;

            &::before {
                content: none !important;
            }
        }

        &-expand,
        &-collapse {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            margin: var(--space-2) var(--space-2) var(--space-1);
            padding: var(--space-2) var(--space-3);
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--primary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition:
                background-color var(--transition-fast),
                border-color var(--transition-fast),
                color var(--transition-fast);

            &:hover {
                background: color-mix(in srgb, var(--primary) 8%, transparent);
                border-color: var(--primary);
            }

            &:focus-visible {
                outline: 2px solid var(--focus-color);
                outline-offset: 2px;
            }
        }
    }

    // -------------------------------------------------------------------------
    // Labels & Custom Radio/Checkbox Styling
    // -------------------------------------------------------------------------
    .facet label,
    .category label,
    .select-list-item label {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        margin: 0;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: background-color var(--transition-fast);
        overflow: hidden;

        &:hover {
            background: var(--bg-muted);
        }

        // Custom radio button styling
        input[type="radio"],
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
            flex-shrink: 0;
            width: 1.125rem;
            height: 1.125rem;
            margin: 0.125rem 0 0 0 !important;
            background: var(--bg-surface);
            border: 2px solid var(--border);
            cursor: pointer;
            transition:
                background-color var(--transition-fast),
                border-color var(--transition-fast),
                box-shadow var(--transition-fast);

            &:hover {
                border-color: var(--primary);
            }

            &:focus-visible {
                outline: 2px solid var(--focus-color);
                outline-offset: 2px;
            }

            &:checked {
                background: var(--primary);
                border-color: var(--primary);

                &::after {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            &::after {
                content: "";
                position: absolute;
                opacity: 0;
                transform: scale(0.5);
                transition:
                    opacity var(--transition-fast),
                    transform var(--transition-fast);
            }
        }

        input[type="radio"] {
            border-radius: 50%;

            &::after {
                top: 50%;
                inset-inline-start: 50%;
                width: 0.375rem;
                height: 0.375rem;
                margin-top: -0.1875rem;
                margin-inline-start: -0.1875rem;
                background: var(--primary-contrast);
                border-radius: 50%;
            }
        }

        input[type="checkbox"] {
            border-radius: var(--radius-sm);

            &::after {
                top: 0.0625rem;
                inset-inline-start: 0.3125rem;
                width: 0.3125rem;
                height: 0.625rem;
                border: solid var(--primary-contrast);
                border-width: 0 2px 2px 0;
                transform: rotate(45deg) scale(0.5);
            }

            &:checked::after {
                transform: rotate(45deg) scale(1);
            }
        }

        // Label text styling
        span,
        >span:first-of-type {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: var(--text-sm);
            line-height: 1.5;
            color: var(--text-primary);
        }
    }

    // Selected/active state for the whole label
    .select-list-item.active label,
    .facet label:has(input:checked) {
        background: color-mix(in srgb, var(--primary) 8%, transparent);

        &:hover {
            background: color-mix(in srgb, var(--primary) 12%, transparent);
        }
    }

    // -------------------------------------------------------------------------
    // Categories List
    // -------------------------------------------------------------------------
    #categories {
        list-style: none;
        margin: 0;
        padding: var(--space-2);

        li {
            border-block-end: none;
            margin: 0;
            padding: 0;

            &::before {
                content: none !important;
            }

            a {
                display: flex;
                align-items: center;
                gap: var(--space-3);
                padding: var(--space-2) var(--space-3);
                border-radius: var(--radius-sm);
                color: var(--text-primary);
                font-size: var(--text-sm);
                text-decoration: none;
                transition:
                    background-color var(--transition-fast),
                    color var(--transition-fast);

                &:hover {
                    background: var(--bg-muted);
                    color: var(--primary);
                }

                &:focus-visible {
                    outline: 2px solid var(--focus-color);
                    outline-offset: -2px;
                    border-radius: var(--radius-sm);
                }

                &::before {
                    content: "";
                    flex-shrink: 0;
                    width: 0.5rem;
                    height: 0.5rem;
                    background: var(--primary);
                    border-radius: 50%;
                    opacity: 0.6;
                    transition: opacity var(--transition-fast);
                }

                &:hover::before {
                    opacity: 1;
                }
            }
        }
    }

    #categories-return {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        margin-block-end: var(--space-3);
        padding: var(--space-2) var(--space-3);
        background: var(--bg-muted);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--primary);
        font-size: var(--text-sm);
        font-weight: 500;
        text-decoration: none;
        transition:
            background-color var(--transition-fast),
            border-color var(--transition-fast),
            color var(--transition-fast);

        &:hover {
            background: color-mix(in srgb, var(--primary) 10%, var(--bg-muted));
            border-color: var(--primary);
            color: var(--primary-hover);
        }

        &:focus-visible {
            outline: 2px solid var(--focus-color);
            outline-offset: 2px;
        }

        &::before {
            @include icon-mask("../img/chevron-left.svg");
            content: "";
            display: inline-block;
            width: var(--text-xs);
            height: var(--text-xs);
            text-decoration: none;
        }
    }

    // -------------------------------------------------------------------------
    // Main Content Area
    // -------------------------------------------------------------------------
    #section-content {
        width: 100%;

        @media (min-width: $xl) {
            width: 75%;
        }

        .browse-controls {
            border-block-end: none;
            margin-block-end: 0;

            .pagination {
                margin-block-start: 0;
            }
        }
    }

    // -------------------------------------------------------------------------
    // Results Display (list/grid mode)
    // -------------------------------------------------------------------------
    .faceted-results,
    .resource-list {
        img {
            max-height: 3rem;
            max-width: 3rem;
            border-radius: var(--radius-sm);
        }
    }

    .faceted-results {
        img {
            margin-inline-end: var(--space-2);
        }
    }

    .resource-name {
        font-weight: 500;
    }

    .resource-list {
        padding-block-start: 5px;

        .resource {
            flex-wrap: wrap;
            padding: var(--space-3) !important;
        }

        .resource-link {
            width: 100%;
        }
    }

    // =========================================================================
    // Table Layout
    // Responsive table with accent-tinted header and warm row hover
    // =========================================================================
    .faceted-browse-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
    }

    table.faceted-results {
        width: 100%;
        min-width: $sm;
        border-collapse: collapse;
        border-spacing: 0;
        margin-block-end: 0; // Wrapper handles spacing

        // ---- Table header ----
        thead {
            th {
                padding: var(--space-3) var(--space-4);
                font-weight: 600;
                font-size: var(--text-sm);
                text-align: start;
                color: color-mix(in srgb, var(--primary) var(--accent-mix-medium), var(--text-heading));
                background: linear-gradient(
                    180deg,
                    color-mix(in srgb, var(--primary) 5%, var(--surface-raised)) 0%,
                    var(--surface-raised) 100%
                );
                border-block-end: var(--accent-line-sm) solid color-mix(in srgb, var(--primary) var(--accent-mix-medium), var(--border));

                &:not(:last-child) {
                    border-inline-end: 1px solid var(--border-light);
                }
            }
        }

        // ---- Table body ----
        tbody {
            tr {
                background-color: var(--bg-surface);
                transition:
                    background-color var(--transition-fast);

                &:hover {
                    background-color: color-mix(in srgb, var(--primary) 3%, var(--surface));
                }
            }

            td {
                padding: var(--space-3) var(--space-4);
                vertical-align: middle;
                font-size: var(--text-sm);
                line-height: var(--line-height-normal);
                border-block-end: 1px solid var(--border-light);

                &:not(:last-child) {
                    border-inline-end: 1px solid var(--border-light);
                }

                // Title column - ensure adequate width
                &:first-child {
                    min-width: 12.5rem;
                }

                // Date column - keep compact but readable
                &:last-child {
                    white-space: nowrap;
                    min-width: 6.25rem;
                }

                // Middle columns - allow wrapping
                &:not(:first-child):not(:last-child) {
                    white-space: normal;
                    word-break: break-word;
                    min-width: 7.5rem;
                }

                // Resource links
                .resource-link {
                    display: inline-flex;
                    align-items: center;
                    gap: var(--space-2);
                    max-width: 100%;
                    text-decoration: none;
                    color: var(--primary);
                    transition: color var(--transition-fast);

                    &:hover {
                        color: var(--primary-hover);
                    }

                    &:focus-visible {
                        outline: 2px solid var(--focus-color);
                        outline-offset: 2px;
                        border-radius: var(--radius-sm);
                    }

                    img {
                        flex-shrink: 0;
                        width: 2.5rem;
                        height: 2.5rem;
                        max-width: 2.5rem;
                        max-height: 2.5rem;
                        object-fit: cover;
                        border-radius: var(--radius-sm);
                    }

                    .resource-name {
                        white-space: normal;
                        word-break: break-word;
                        min-width: 0;
                    }
                }

                // When multiple values, stack them
                >.resource-link+br+.resource-link,
                >br+.resource-link {
                    margin-block-start: var(--space-1);
                }
            }

            // Last row: no bottom border (the wrapper handles it)
            tr:last-child td {
                border-block-end: none;
            }
        }
    }

    // =========================================================================
    // Tablesaw Overrides (Responsive Tables)
    // Desktop: show all columns; Mobile: swipe with navigation
    // =========================================================================
    // Reset tablesaw bar container defaults
    .tablesaw-bar {
        clear: both;
        overflow: visible;
    }

    .tablesaw {

        // Desktop: force all columns visible
        @media (min-width: $lg) {

            th.tablesaw-swipe-cellhidden,
            td.tablesaw-swipe-cellhidden {
                display: table-cell !important;
            }
        }

        // Highlight the persistent/pinned column on mobile
        @media (max-width: #{$lg - 1}) {
            td.tablesaw-cell-persist {
                font-weight: 500;
            }
        }

        // Tablesaw navigation bar for mobile column swiping
        &-advance {
            display: flex !important;
            float: none !important;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            margin-block-start: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: var(--surface-raised);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);

            @media (min-width: $lg) {
                display: none !important;
            }

            // Override module's .btn / .btn-micro classes
            .tablesaw-nav-btn,
            a.tablesaw-nav-btn.btn {
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                width: 2.5rem;
                height: 2.5rem;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 1rem !important;
                font-weight: 500;
                line-height: 1 !important;
                background: var(--surface) !important;
                border: 1px solid var(--border) !important;
                border-radius: var(--radius-sm) !important;
                color: var(--text-primary) !important;
                text-indent: -9999px !important; // Hide text, show arrow only
                text-decoration: none !important;
                overflow: hidden !important;
                cursor: pointer;
                transition:
                    background-color var(--transition-fast),
                    border-color var(--transition-fast),
                    color var(--transition-fast);

                // Center the CSS triangle arrows
                &::before {
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    border-top-width: 6px !important;
                    border-bottom-width: 6px !important;
                }

                &.left::before {
                    border-right: 6px solid var(--text-primary) !important;
                    margin-left: -1px; // Optical centering for left triangle
                }

                &.right::before {
                    border-left: 6px solid var(--text-primary) !important;
                    margin-left: 1px; // Optical centering for right triangle
                }

                &:hover:not(.disabled) {
                    background: color-mix(in srgb, var(--primary) 10%, var(--surface)) !important;
                    border-color: var(--primary) !important;

                    &.left::before {
                        border-right-color: var(--primary) !important;
                    }

                    &.right::before {
                        border-left-color: var(--primary) !important;
                    }
                }

                &:focus-visible {
                    outline: 2px solid var(--focus-color);
                    outline-offset: 2px;
                }

                &.disabled {
                    opacity: 0.35;
                    cursor: not-allowed;
                    pointer-events: none;

                    &.left::before {
                        border-right-color: var(--muted) !important;
                    }

                    &.right::before {
                        border-left-color: var(--muted) !important;
                    }
                }
            }
        }

        // Column label in mobile stacked/swipe mode
        &-cell-label {
            font-weight: 600;
            font-size: var(--text-xs);
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
    }
}

// =============================================================================
// Body scroll lock when filter sidebar is open (mobile)
// =============================================================================
body:has(.faceted-browse-page #section-sidebar.open),
body:has(.block-facetedBrowsePreview #section-sidebar.open) {
    overflow: hidden !important;

    @media (min-width: $xl) {
        overflow: visible !important;
    }
}
