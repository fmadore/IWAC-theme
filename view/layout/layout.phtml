<?php
$siteTitle = $site->title();
$userBar = $this->userBar();
$header_layout = ($this->themeSetting('header_layout')) ?? 'inline';
$body_class = 'main-header--' . $header_layout;
$bannerHeightMobile = $this->themeSetting('banner_height_mobile');
$bannerHeading = $this->themeSetting('banner_heading');
$bannerDescription = $this->themeSetting('banner_description');
$bannerHeightProperty = $bannerHeading || $bannerDescription ? 'min-height' : 'height';
$primaryColor = $this->themeSetting('primary_color') ?? '#e77f11';
$secondaryColor = $this->themeSetting('secondary_color') ?? '#394f68';
$accentColor = $this->themeSetting('accent_color') ?? '#394f68';

// Convert hex to HSL for CSS custom properties
function hexToHsl($hex) {
    $hex = ltrim($hex, '#');
    $r = hexdec(substr($hex, 0, 2)) / 255;
    $g = hexdec(substr($hex, 2, 2)) / 255;
    $b = hexdec(substr($hex, 4, 2)) / 255;
    
    $max = max($r, $g, $b);
    $min = min($r, $g, $b);
    $l = ($max + $min) / 2;
    
    if ($max == $min) {
        $h = $s = 0;
    } else {
        $d = $max - $min;
        $s = $l > 0.5 ? $d / (2 - $max - $min) : $d / ($max + $min);
        switch ($max) {
            case $r: $h = (($g - $b) / $d + ($g < $b ? 6 : 0)) / 6; break;
            case $g: $h = (($b - $r) / $d + 2) / 6; break;
            case $b: $h = (($r - $g) / $d + 4) / 6; break;
        }
    }
    
    return [
        'h' => round($h * 360),
        's' => round($s * 100),
        'l' => round($l * 100)
    ];
}

$primaryHsl = hexToHsl($primaryColor);
$secondaryHsl = hexToHsl($secondaryColor);
$accentHsl = hexToHsl($accentColor);

$this->htmlElement('html')->setAttribute('lang', $this->lang());
$this->headMeta()->setCharset('utf-8');
$this->headMeta()->appendName('viewport', 'width=device-width, initial-scale=1');
$this->headTitle($siteTitle)->setSeparator(' Â· ');
$this->headTitle()->append($this->setting('installation_title', 'Omeka S'));
$this->headLink()->prependStylesheet($this->assetUrl('css/style.css'));
$this->headLink()->prependStylesheet($this->assetUrl('css/iconfonts.css', 'Omeka'));
$this->headLink()->prependStylesheet('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
$this->headLink()->prependStylesheet('https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap');
$this->headScript()->prependFile($this->assetUrl('js/global.js', 'Omeka'));
$this->headScript()->prependFile($this->assetUrl('vendor/jquery/jquery.min.js', 'Omeka'));
$this->jsTranslate();
$this->trigger('view.layout');

if ($userBar) {
	$this->htmlElement('body')->appendAttribute('class', 'user-bar');
}
?>

<?php echo $this->doctype(); ?>
<?php echo $this->htmlElement('html'); ?>
	<head>
		<?php echo $this->headMeta(); ?>
		<?php echo $this->headTitle(); ?>
		<?php echo $this->headLink(); ?>
		<?php echo $this->headStyle(); ?>
		<?php echo $this->headScript(); ?>

		<style type="text/css" media="screen">
			:root {
				/* Primary color from admin settings - HSL for theme system */
				--primary-hue: <?php echo $primaryHsl['h']; ?>;
				--primary-sat: <?php echo $primaryHsl['s']; ?>%;
				--primary: hsl(var(--primary-hue), var(--primary-sat), <?php echo $primaryHsl['l']; ?>%);
				--primary-hover: hsl(var(--primary-hue), var(--primary-sat), <?php echo max(0, $primaryHsl['l'] - 5); ?>%);
				--primary-active: hsl(var(--primary-hue), var(--primary-sat), <?php echo max(0, $primaryHsl['l'] - 10); ?>%);
				--primary-contrast: <?php echo $this->ContrastColor($primaryColor, ['#fff', '#333']); ?>;
				
				/* Secondary color from admin settings */
				--secondary-hue: <?php echo $secondaryHsl['h']; ?>;
				--secondary-sat: <?php echo $secondaryHsl['s']; ?>%;
				--secondary: hsl(var(--secondary-hue), var(--secondary-sat), <?php echo $secondaryHsl['l']; ?>%);
				--secondary-dark: <?php echo $this->ShadeColor($secondaryColor, -10); ?>;
				--secondary-contrast: <?php echo $this->ContrastColor($secondaryColor, ['#fff', '#333']); ?>;
				
				/* Accent color from admin settings */
				--accent-hue: <?php echo $accentHsl['h']; ?>;
				--accent-sat: <?php echo $accentHsl['s']; ?>%;
				--accent: hsl(var(--accent-hue), var(--accent-sat), <?php echo $accentHsl['l']; ?>%);
				--accent-dark: <?php echo $this->ShadeColor($accentColor, -10); ?>;
			}
		</style>
		
		<?php if($bannerHeightMobile): ?>
		<style type="text/css" media="screen and (max-width:768px)">
			.banner {
				<?php echo "{$bannerHeightProperty}: {$bannerHeightMobile} !important;"; ?>
			}
		</style>
		<?php endif; ?>
	</head>

	<?php echo $this->htmlElement('body')->appendAttribute('class', $body_class); ?>
		<a id="skipnav" href="#content"><?php echo $this->translate('Skip to main content'); ?></a>

		<?php echo $this->partial('common/header', ['userBar' => $userBar, 'site' => $site]); ?>

		<?php echo $this->partial('common/banner'); ?>

		<div id="main-content" class="container" role="main">
			<?php echo $this->content; ?>
		</div>

		<?php echo $this->partial('common/footer'); ?>

		<?php
		echo $this->inlineScript()
			->prependFile($this->assetUrl('js/theme-toggle.js'))
			->prependFile($this->assetUrl('js/navigation.js'))
			->prependFile($this->assetUrl('js/script.js'));
		?>
	</body>
</html>
