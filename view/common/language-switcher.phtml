<?php
/**
 * Language Switcher
 * 
 * Custom template for the Internationalisation module's language switcher.
 * Displays available site languages with language codes.
 * 
 * Variables provided by the Internationalisation module:
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SiteRepresentation $site
 * @var string $defaultLocale The default locale set in main settings or config (xx_YY)
 * @var array $locales Array of locale data with keys: site, locale, locale_label, url
 * @var array $localeLabels Associative array of locale id => locale label
 * @var string $displayLocale "code" (default) or "flag"
 */

// No switcher if there is only one site or a single language
if (empty($locales) || count($locales) <= 1) {
    return;
}

$escape = $this->plugin('escapeHtml');
$escapeAttr = $this->plugin('escapeHtmlAttr');
$translate = $this->plugin('translate');

// Get current locale from site settings
$currentLocale = $this->siteSetting('locale') ?: ($defaultLocale ?? 'en');
?>

<nav class="language-switcher" aria-label="<?php echo $escapeAttr($translate('Language selection')); ?>">
    <ul class="language-switcher__list">
        <?php foreach ($locales as $localeData): 
            $siteLocale = $localeData['locale'] ?? '';
            $siteLocaleShort = rtrim(substr($siteLocale, 0, 3), '_-');
            $isCurrentLang = ($siteLocale === $currentLocale);
            $langName = $localeData['locale_label'] ?? $siteLocaleShort;
            $siteUrl = $localeData['url'] ?? '#';
        ?>
            <li class="language-switcher__item <?php echo $isCurrentLang ? 'language-switcher__item--active' : ''; ?>">
                <?php if ($isCurrentLang): ?>
                    <span class="language-switcher__link language-switcher__link--current" 
                          aria-current="true"
                          title="<?php echo $escapeAttr($langName); ?> (<?php echo $escape($translate('current')); ?>)">
                        <span class="language-switcher__code" aria-hidden="true"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="screen-reader-text"><?php echo $escape($langName); ?> (<?php echo $escape($translate('current language')); ?>)</span>
                    </span>
                <?php else: ?>
                    <a href="<?php echo $escapeAttr($siteUrl); ?>" 
                       class="language-switcher__link"
                       hreflang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>"
                       lang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>"
                       title="<?php echo $escapeAttr($langName); ?>">
                        <span class="language-switcher__code" aria-hidden="true"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="screen-reader-text"><?php echo $escape($langName); ?></span>
                    </a>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
    </ul>
</nav>
