<?php
/**
 * Language Switcher
 * 
 * Custom template for the Internationalisation module's language switcher.
 * Displays a dropdown menu with available site languages, triggered by a globe icon button.
 * Designed to match the theme toggle button styling.
 * 
 * Variables provided by the Internationalisation module:
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SiteRepresentation $site
 * @var string $defaultLocale The default locale set in main settings or config (xx_YY)
 * @var array $locales Array of locale data with keys: site, locale, locale_label, url
 * @var array $localeLabels Associative array of locale id => locale label
 * @var string $displayLocale "code" (default) or "flag"
 */

// Debug: uncomment the next line to see what data is being passed
// echo '<!-- DEBUG locales: ' . print_r($locales, true) . ' -->';

// No switcher if there are no locales available
if (empty($locales)) {
    return;
}

$escape = $this->plugin('escapeHtml');
$escapeAttr = $this->plugin('escapeHtmlAttr');
$translate = $this->plugin('translate');

// Get current locale from site settings (matching reference theme pattern)
$currentLocale = $this->siteSetting('locale') ?: 'en_US';
$currentLocaleShort = rtrim(substr($currentLocale, 0, 3), '_-');
?>

<div class="language-switcher language-switcher--dropdown" data-language-switcher>
    <button class="language-switcher__toggle" type="button" aria-expanded="false" aria-haspopup="listbox"
        aria-label="<?php echo $escapeAttr($translate('Select language')); ?>"
        title="<?php echo $escapeAttr($translate('Change language')); ?>">
        <span class="language-switcher__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-translate"
                viewBox="0 0 16 16">
                <path
                    d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286zm1.634-.736L5.5 3.956h-.049l-.679 2.022z" />
                <path
                    d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm7.138 9.995q.289.451.63.846c-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6 6 0 0 1-.415-.492 2 2 0 0 1-.94.31" />
            </svg>
        </span>
        <span class="language-switcher__current-code"><?php echo $escape(strtoupper($currentLocaleShort)); ?></span>
    </button>
    <ul class="language-switcher__list" role="listbox"
        aria-label="<?php echo $escapeAttr($translate('Available languages')); ?>">
        <?php foreach ($locales as $localeData):
            $siteLocale = $localeData['locale'] ?? '';
            $siteLocaleShort = rtrim(substr($siteLocale, 0, 3), '_-');
            $isCurrentLang = ($siteLocale === $currentLocale);
            // Extract just the language name without locale code in parentheses (e.g., "English" from "English (en-US)")
            $langName = ucwords(explode(' (', $localeData['locale_label'] ?? $siteLocaleShort)[0]);
            $siteUrl = $localeData['url'] ?? '#';
            ?>
            <li class="language-switcher__item <?php echo $isCurrentLang ? 'language-switcher__item--active' : ''; ?>"
                role="option" aria-selected="<?php echo $isCurrentLang ? 'true' : 'false'; ?>">
                <?php if ($isCurrentLang): ?>
                    <span class="language-switcher__link language-switcher__link--current">
                        <span class="language-switcher__code"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="language-switcher__label"><?php echo $escape($langName); ?></span>
                        <span class="language-switcher__check" aria-hidden="true">âœ“</span>
                    </span>
                <?php else: ?>
                    <a href="<?php echo $escapeAttr($siteUrl); ?>" class="language-switcher__link"
                        hreflang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>"
                        lang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>">
                        <span class="language-switcher__code"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="language-switcher__label"><?php echo $escape($langName); ?></span>
                    </a>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
    </ul>
</div>