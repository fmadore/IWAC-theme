<?php
/**
 * Language Switcher
 * 
 * Custom template for the Internationalisation module's language switcher.
 * Displays a dropdown menu with available site languages, triggered by a globe icon button.
 * Designed to match the theme toggle button styling.
 * 
 * Variables provided by the Internationalisation module:
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SiteRepresentation $site
 * @var string $defaultLocale The default locale set in main settings or config (xx_YY)
 * @var array $locales Array of locale data with keys: site, locale, locale_label, url
 * @var array $localeLabels Associative array of locale id => locale label
 * @var string $displayLocale "code" (default) or "flag"
 */

// Debug: uncomment the next line to see what data is being passed
// echo '<!-- DEBUG locales: ' . print_r($locales, true) . ' -->';

// No switcher if there are no locales available
if (empty($locales)) {
    return;
}

$escape = $this->plugin('escapeHtml');
$escapeAttr = $this->plugin('escapeHtmlAttr');
$translate = $this->plugin('translate');

// Get current locale from site settings (matching reference theme pattern)
$currentLocale = $this->siteSetting('locale') ?: 'en_US';
$currentLocaleShort = rtrim(substr($currentLocale, 0, 3), '_-');
?>

<div class="language-switcher language-switcher--dropdown" data-language-switcher>
    <button class="language-switcher__toggle" 
            type="button"
            aria-expanded="false"
            aria-haspopup="listbox"
            aria-label="<?php echo $escapeAttr($translate('Select language')); ?>"
            title="<?php echo $escapeAttr($translate('Change language')); ?>">
        <span class="language-switcher__icon" aria-hidden="true"></span>
        <span class="language-switcher__current-code"><?php echo $escape(strtoupper($currentLocaleShort)); ?></span>
    </button>
    <ul class="language-switcher__list" role="listbox" aria-label="<?php echo $escapeAttr($translate('Available languages')); ?>">
        <?php foreach ($locales as $localeData): 
            $siteLocale = $localeData['locale'] ?? '';
            $siteLocaleShort = rtrim(substr($siteLocale, 0, 3), '_-');
            $isCurrentLang = ($siteLocale === $currentLocale);
            // Extract just the language name without locale code in parentheses (e.g., "English" from "English (en-US)")
            $langName = ucwords(explode(' (', $localeData['locale_label'] ?? $siteLocaleShort)[0]);
            $siteUrl = $localeData['url'] ?? '#';
        ?>
            <li class="language-switcher__item <?php echo $isCurrentLang ? 'language-switcher__item--active' : ''; ?>" 
                role="option"
                aria-selected="<?php echo $isCurrentLang ? 'true' : 'false'; ?>">
                <?php if ($isCurrentLang): ?>
                    <span class="language-switcher__link language-switcher__link--current">
                        <span class="language-switcher__code"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="language-switcher__label"><?php echo $escape($langName); ?></span>
                        <span class="language-switcher__check" aria-hidden="true">âœ“</span>
                    </span>
                <?php else: ?>
                    <a href="<?php echo $escapeAttr($siteUrl); ?>" 
                       class="language-switcher__link"
                       hreflang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>"
                       lang="<?php echo $escapeAttr(str_replace('_', '-', $siteLocale)); ?>">
                        <span class="language-switcher__code"><?php echo $escape(strtoupper($siteLocaleShort)); ?></span>
                        <span class="language-switcher__label"><?php echo $escape($langName); ?></span>
                    </a>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
    </ul>
</div>
