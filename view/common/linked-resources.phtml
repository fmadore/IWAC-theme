<?php
use Laminas\Form\Element\Select;

$this->inlineScript()->appendFile($this->assetUrl('js/accordion.js'));
$this->inlineScript()->appendFile($this->assetUrl('js/linked-resources.js'));

// Set up pagination.
$pagination = $this->pagination(null, $totalCount, $page, $perPage);
$fragment = 'resources-linked';
$pagination->setFragment($fragment);

// Set up locale.
$valueLang = null;
if ($this->status()->isSiteRequest()) {
    $lang = $this->lang();
    $filterLocale = (bool) $this->siteSetting('filter_locale_values');
    $valueLang = $filterLocale ? [$lang, ''] : null;
}

// Set up resource property select.
$labelMap = [
    'items' => 'Items', // @translate
    'item_sets' => 'Item sets', // @translate
    'media' => 'Media', // @translate
];
$resourcePropertiesSelect = new Select('resource_property');
$resourcePropertiesSelect->setValue($resourceProperty);
$resourcePropertiesSelect->setAttributes([
    'id' => 'resource-property-select',
    'class' => 'linked-resources__filter-select',
    'data-url' => $this->url(null, [], true),
    'data-fragment' => $fragment,
    'aria-label' => $this->translate('Filter by resource type and property'),
]);
$valueOptions = [];
foreach ($resourcePropertiesAll as $type => $resourceProperties) {
    if (!$resourceProperties) {
        continue;
    }
    $valueOptions[$type] = [
        'label' => $labelMap[$type],
        'options' => [sprintf('%s:', $type) => sprintf('%s: All', $labelMap[$type])],
    ];
    foreach ($resourceProperties as $resourceProperty) {
        $label = $resourceProperty['label_is_translatable']
            ? $this->translate($resourceProperty['label'])
            : $resourceProperty['label'];

        $valueOptions[$type]['options'][] = [
            'value' => $resourceProperty['compound_id'],
            'label' => sprintf('%s: %s', $labelMap[$type], $label),
            'attributes' => [
                'title' => $resourceProperty['term'],
            ],
        ];
    }
}
$resourcePropertiesSelect->setValueOptions($valueOptions);

// Sort options
$sortOptions = [
    'default' => $this->translate('Default'),
    'alpha-asc' => $this->translate('Title (A-Z)'),
    'alpha-desc' => $this->translate('Title (Z-A)'),
    'date-desc' => $this->translate('Newest first'),
    'date-asc' => $this->translate('Oldest first'),
];

// Translations for JS
$noResultsText = $this->translate('No resources found');
$resultsFoundText = $this->translate('{count} resources found');
?>
<div id="linked-resources">

<div class="linked-resources__controls">
    <div class="linked-resources__search">
        <img src="<?php echo $this->assetUrl('img/search.svg'); ?>"
             class="linked-resources__search-icon"
             alt=""
             aria-hidden="true">
        <input type="search"
               class="linked-resources__search-input"
               placeholder="<?php echo $this->escapeHtmlAttr($this->translate('Filter by title...')); ?>"
               aria-label="<?php echo $this->escapeHtmlAttr($this->translate('Filter linked resources by title')); ?>">
    </div>

    <div class="linked-resources__sort">
        <label for="linked-resources-sort" class="sr-only">
            <?php echo $this->translate('Sort by'); ?>
        </label>
        <select id="linked-resources-sort" class="linked-resources__sort-select">
            <?php foreach ($sortOptions as $value => $label): ?>
                <option value="<?php echo $this->escapeHtmlAttr($value); ?>">
                    <?php echo $this->escapeHtml($label); ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>

    <div class="linked-resources__filter">
        <label for="resource-property-select" class="sr-only">
            <?php echo $this->translate('Filter by type'); ?>
        </label>
        <?php echo $this->formElement($resourcePropertiesSelect); ?>
    </div>
</div>

<div class="linked-resources__status" role="status" aria-live="polite" aria-atomic="true"></div>

<div class="linked-resources__no-results" style="display: none;" aria-hidden="true">
    <p><?php echo $this->escapeHtml($this->translate('No resources match your search.')); ?></p>
</div>

<?php foreach ($subjectValues as $values): ?>
    <?php
    $caption = sprintf(
        $this->translate('%s with "%s: %s"'),
        $this->translate($labelMap[$resourceType]),
        $values[0]['property_alternate_label'] ?? $this->translate($values[0]['property_label']),
        $objectResource->displayTitle()
    );
    $itemCount = count($values);
    ?>

    <div class="linked-resource-accordion accordion__container">
        <h4 class="linked-resource-heading accordion__heading">
            <button class="linked-resource-property accordion__trigger"
                    type="button"
                    aria-expanded="false"
                    aria-controls="accordion__panel-<?php echo $values[0]['property_id']; ?>"
                    id="accordion-<?php echo $values[0]['property_id']; ?>">
                <span class="accordion__title">
                    <?php echo $this->escapeHtml($caption); ?>
                    <span class="linked-resource-count" data-original-count="<?php echo $itemCount; ?>">(<?php echo $itemCount; ?>)</span>
                    <span class="accordion__icon o-icon-chevron-down"></span>
                </span>
            </button>
        </h4>

        <div class="linked-resource-property__panel accordion__panel"
            id="accordion__panel-<?php echo $values[0]['property_id']; ?>"
            role="region"
            aria-labelledby="accordion-<?php echo $values[0]['property_id']; ?>">
            <?php foreach ($values as $value): ?>
                <?php
                $valueResource = $value['val']->resource();
                $resourceTitle = $valueResource->displayTitle(null, $valueLang);
                $resourceCreated = $valueResource->created() ? $valueResource->created()->format('c') : '';
                ?>
                <div class="linked-resource"
                     data-title="<?php echo $this->escapeHtmlAttr($resourceTitle); ?>"
                     data-date="<?php echo $this->escapeHtmlAttr($resourceCreated); ?>">
                    <span class="linked-resource__link"><?php echo $valueResource->linkPretty('square', null, null, null, $valueLang); ?></span>
                    <?php echo $this->ResourceTags($valueResource); ?>
                </div>
            <?php endforeach; ?>
        </div>
    </div>

<?php endforeach; ?>

<?php echo ($totalCount > $perPage) ? '<div class="linked-footer">' . $pagination . '</div>' : ''; ?>

</div>

<script>
const linkedResourcesNoResults = <?php echo json_encode($noResultsText); ?>;
const linkedResourcesResultsFound = <?php echo json_encode($resultsFoundText); ?>;

const propertySelect = document.getElementById('resource-property-select');
if (propertySelect) {
    const url = propertySelect.dataset.url;
    const fragment = propertySelect.dataset.fragment;
    propertySelect.addEventListener('change', function(e) {
        const resourceProperty = this.value;
        window.location = url + '?' + new URLSearchParams({resource_property: resourceProperty}).toString() + '#' + fragment;
    });
}
</script>
